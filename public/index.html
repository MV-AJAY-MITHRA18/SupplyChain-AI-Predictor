<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise Grounded Logistics Control Tower</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .kpi-value { font-size: 2.25rem; font-weight: 800; }
        .alert-row-expedite { background-color: #fef2f2; border-left: 5px solid #ef4444; }
        .alert-row-reroute { background-color: #fff7ed; border-left: 5px solid #f97316; }
        .alert-row-monitor { border-left: 5px solid #3b82f6; }
        .card { transition: all 0.2s ease-in-out; border-radius: 0.75rem; }
        .hidden-rbac { display: none; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 1000; display: flex; justify-content: center; align-items: center; color: white; font-size: 1.5rem; }
    </style>
</head>
<body class="p-8">
    <div id="loading-overlay" class="hidden">
        <p>Running Real-Time Geo-Analysis (Calling Gemini AI)...</p>
    </div>

    <div class="max-w-8xl mx-auto">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Prescriptive Logistics Control Tower (Grounded AI)</h1>
        <p class="text-md text-gray-500 mb-8">AI analysis uses real-time web search (Simulated API) to assess risk factors like weather and labor strikes.</p>

        <div class="flex space-x-6 mb-6">
            <div class="p-3 bg-white rounded-lg shadow flex items-center space-x-3 border border-indigo-200">
                <label for="role-select" class="text-sm font-medium text-gray-700">User Role (RBAC):</label>
                <select id="role-select" class="p-1 border border-gray-300 rounded-md text-sm">
                    <option value="Supervisor">Supervisor (Full Access)</option>
                    <option value="Operator">Logistics Operator (Action Only)</option>
                </select>
            </div>

            <div class="p-3 bg-white rounded-lg shadow flex items-center space-x-3 border border-green-200">
                <label for="region-select" class="text-sm font-medium text-gray-700">Assigned Region:</label>
                <select id="region-select" class="p-1 border border-gray-300 rounded-md text-sm">
                    <option value="ALL">ALL REGIONS</option>
                    <option value="North America">North America</option>
                    <option value="Europe">Europe</option>
                    <option value="Asia">Asia</option>
                </select>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
            
            <div class="col-span-1 bg-white p-6 card shadow-xl border-t-4 border-red-600 hidden-rbac" data-role="Supervisor">
                <div class="text-sm font-semibold text-red-600 uppercase">Total Predicted Financial Exposure</div>
                <div id="kpi-total-loss" class="kpi-value text-red-700 mt-2">$0.00</div>
                <p class="text-xs text-gray-500 mt-1">Sum of expected loss across all high-risk orders.</p>
            </div>
            
            <div class="col-span-1 bg-white p-6 card shadow-xl border-t-4 border-green-600 hidden-rbac" data-role="Supervisor">
                <div class="text-sm font-semibold text-green-600 uppercase">Total Potential Net Benefit</div>
                <div id="kpi-total-benefit" class="kpi-value text-green-700 mt-2">$0.00</div>
                <p class="text-xs text-gray-500 mt-1">Money saved by following all AI recommendations.</p>
            </div>
            
            <div class="col-span-1 bg-white p-6 card shadow-xl border-t-4 border-yellow-600">
                <div class="text-sm font-semibold text-yellow-600 uppercase">Urgent Intervention Count</div>
                <div id="kpi-alert-count" class="kpi-value text-yellow-700 mt-2">0</div>
                <p class="text-xs text-gray-500 mt-1">Orders requiring immediate EXPEDITE or REROUTE action.</p>
            </div>

            <div class="col-span-1 bg-white p-6 card shadow-xl border-t-4 border-indigo-600">
                <h3 class="text-sm font-semibold text-indigo-600 uppercase mb-3">Risk Trend Analysis</h3>
                <div id="kpi-risk-trend" class="flex items-center space-x-2">
                    <svg id="trend-icon" class="w-8 h-8 text-gray-500" fill="currentColor" viewBox="0 0 20 20"></svg>
                    <div class="kpi-value text-xl" id="trend-value">--</div>
                </div>
                <p class="text-xs text-gray-500 mt-1">Change in average risk vs. historical baseline.</p>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-2xl border-t-4 border-gray-400">
            <h2 class="text-xl font-bold text-gray-700 mb-4">Priority Intervention Queue (Pre-filtered by AI)</h2>
            <p class="text-sm text-gray-500 mb-6">Showing only orders where intervention is cost-justified. Sorted by highest Net Benefit.</p>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order ID</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Destination</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-red-600 uppercase tracking-wider">Risk %</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-green-600 uppercase tracking-wider">Prescribed Action</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-indigo-600 uppercase tracking-wider">Top Drivers (SHAP)</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden-rbac" data-role="Supervisor">Expected Loss</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-green-600 uppercase tracking-wider hidden-rbac" data-role="Supervisor">Net Benefit ($)</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden-rbac" data-role="Supervisor">Real-Time Factors</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Region</th>
                        </tr>
                    </thead>
                    <tbody id="alerts-table-body" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="9" class="px-4 py-4 text-sm text-gray-500 text-center">Awaiting Real-Time AI Analysis...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="mt-8 bg-white p-6 rounded-xl shadow-2xl border-t-4 border-indigo-600">
             <h3 class="text-xl font-bold text-gray-700 mb-3">Top 3 Primary Risk Drivers (Visualized)</h3>
             <div id="bottom-chart-container" class="h-40 w-full">
                <p class="text-gray-500 text-center text-sm pt-12">Loading Chart...</p>
            </div>
        </div>
    </div>

    <script type="module">
        // --- 1. CORE DATA SIMULATION ---
        const TMS_DATA = [
            { id: 'ORD-54321', destination: 'Jebel Ali Port, UAE', product: 'Automotive Engine Blocks', scheduled_days: 22, origin: 'WH Detroit', mode: 'Ocean', region: 'Asia' },
            { id: 'ORD-99801', destination: 'LA/Long Beach Port, US', product: 'High-Purity Pharma API', scheduled_days: 4, origin: 'WH Mumbai', mode: 'Air', region: 'North America' },
            { id: 'ORD-30012', destination: 'Dallas, TX', product: 'Luxury Electronics Displays', scheduled_days: 7, origin: 'WH Shanghai', mode: 'Rail', region: 'North America' },
            { id: 'ORD-10934', destination: 'Port of Rotterdam, NL', product: 'Industrial Grade Steel', scheduled_days: 14, origin: 'WH Brazil', mode: 'Ocean', region: 'Europe' },
            { id: 'ORD-40056', destination: 'Atlanta, GA', product: 'Standard Office Supplies', scheduled_days: 5, origin: 'WH Chicago', mode: 'Truck', region: 'North America' },
            { id: 'ORD-77123', destination: 'Port of Singapore, SG', product: 'Basic Consumer Textiles', scheduled_days: 30, origin: 'WH EU', mode: 'Ocean', region: 'Asia' },
            { id: 'ORD-81145', destination: 'New York, NY', product: 'Retail Apparel', scheduled_days: 2, origin: 'WH New Jersey', mode: 'Truck', region: 'North America' },
            { id: 'ORD-60589', destination: 'Houston, TX', product: 'Oil & Gas Equipment', scheduled_days: 10, origin: 'WH Tulsa', mode: 'Rail', region: 'North America' },
            { id: 'ORD-12345', destination: 'LA/Long Beach Port, US', product: 'Perishable Produce', scheduled_days: 2, origin: 'WH Mexico', mode: 'Truck', region: 'North America' },
            { id: 'ORD-78901', destination: 'Dallas, TX', product: 'Standard Office Supplies', scheduled_days: 6, origin: 'WH Seattle', mode: 'Rail', region: 'North America' },
            { id: 'ORD-13579', destination: 'Port of Rotterdam, NL', product: 'Automotive Engine Blocks', scheduled_days: 18, origin: 'WH Detroit', mode: 'Ocean', region: 'Europe' },
            { id: 'ORD-24680', destination: 'Atlanta, GA', product: 'Luxury Electronics Displays', scheduled_days: 8, origin: 'WH Shanghai', mode: 'Air', region: 'North America' },
        ];
        
        const HISTORICAL_AVG_RISK = 0.35; 
        
        // --- 2. ADVANCED: DETERMINISTIC GROUNDED ANALYSIS (REPLACING FAILED API CALLS) ---
        // This function now uses internal deterministic rules to simulate the output of a real-time AI call.
        function runExternalAnalysis(destination) {
            
            // Randomness factor to simulate real-time volatility across refreshes
            const rand = Math.random();
            
            let weather = Math.floor(rand * 3) + 2; // Default weather severity (2, 3, or 4)
            let strike = 0;
            let customs = 0;
            let summary = 'Simulated Analysis: Stable Conditions.';

            // Deterministic logic based on destination/type (mimicking real-world rules)
            if (destination.includes('LA/Long Beach Port, US')) {
                // High risk for US West Coast ports (Strikes, weather variability)
                strike = rand < 0.6 ? 1 : 0; 
                weather = Math.floor(rand * 3) + 3; // Higher chance of bad weather (3, 4, 5)
                summary = strike ? 'HIGH RISK: Simulated Port Strike & Severe Weather.' : 'MODERATE RISK: Weather Volatility.';
            } else if (destination.includes('Rotterdam')) {
                 // Moderate risk for Europe (Customs, traffic)
                 strike = rand < 0.3 ? 1 : 0; 
                 customs = rand < 0.5 ? 1 : 0;
                 summary = strike ? 'HIGH RISK: Simulated Labor Action in Europe.' : 'MODERATE RISK: Customs & Traffic.';
            } else if (destination.includes('Jebel Ali')) {
                 // High risk for Middle East (Customs, Geopolitical)
                 customs = rand < 0.7 ? 1 : 0; 
                 summary = 'HIGH RISK: Simulated Geopolitical and Customs Inspection Delay.';
            } else if (destination.includes('Singapore')) {
                 // Lower risk, but traffic and congestion
                 weather = Math.floor(rand * 2) + 2; 
                 customs = rand < 0.3 ? 1 : 0; 
                 summary = 'LOW RISK: Stable, monitoring slight congestion.';
            }

            return {
                weather: weather,
                strike: strike,
                customs: customs,
                traffic: Math.random() < 0.3 ? 1 : 0, // General traffic fluctuation
                summary: summary
            };
        }

        // --- 3. AI CORE PREDICTION LOGIC ---
        function runAIPrediction(shipment, factors) {
            const { weather, traffic, strike, customs } = factors;
            
            let baseRisk = 0.15;
            
            // Apply weighted risk factors
            let risk = baseRisk + 
                       (weather / 5) * 0.10 +      // Weather adds up to 10% risk
                       (customs) * 0.20 +          // Customs adds 20% risk
                       (strike) * 0.30 +           // Strike adds 30% risk
                       (traffic) * 0.10;           // Traffic adds 10% risk

            // Adjustment for product value/complexity
            if (shipment.product.includes('Pharma')) risk += 0.15;
            if (shipment.scheduled_days > 15) risk += 0.05; 

            let probability = Math.min(0.99, risk); 

            // SHAP-like Root Cause Attribution
            let drivers = [];
            if (strike) drivers.push("Global/Port Strike Alert");
            if (customs) drivers.push("Customs Clearance Delay");
            if (weather >= 4) drivers.push("Severe Weather Forecast");
            if (traffic) drivers.push("Route Congestion/Traffic");
            if (shipment.product.includes('Perishable')) drivers.push("Perishables/Shelf Life Risk");
            if (shipment.mode === 'Ocean') drivers.push("Ocean Route Volatility");

            return { probability, drivers: drivers.join(', ') || 'Standard Operational Risk' };
        }

        // --- 4. PRESCRIPTIVE OPTIMIZATION LOGIC ---
        function prescribeAction(probability, product) {
            const HIGH_COST_RATE = 3.0; 
            const LOW_COST_RATE = 1.0;
            const COST_EXPEDITE = 1200; 
            const COST_REROUTE = 500;
            const REDUCTION_EXPEDITE = 0.90; 
            const REDUCTION_REROUTE = 0.60; 
            const PROBABILITY_THRESHOLD = 0.50; 

            const costRate = product.includes('High Cost') || product.includes('Pharma') ? HIGH_COST_RATE : LOW_COST_RATE;
            const avgDelayMinutes = 240; 
            const potentialLossUSD = probability * (avgDelayMinutes * costRate + 1000); 

            let action = "MONITOR";
            let netBenefit = 0;

            if (probability >= PROBABILITY_THRESHOLD) {
                const benefitExpedite = (potentialLossUSD * REDUCTION_EXPEDITE) - COST_EXPEDITE;
                const benefitReroute = (potentialLossUSD * REDUCTION_REROUTE) - COST_REROUTE;

                if (benefitExpedite > benefitReroute && benefitExpedite > 0) {
                    action = "EXPEDITE (Critical)";
                    netBenefit = benefitExpedite;
                } else if (benefitReroute > 0) {
                    action = "REROUTE (High Priority)";
                    netBenefit = benefitReroute;
                } else {
                     action = "ALERT (Intervention Too Costly)";
                     netBenefit = -potentialLossUSD; 
                }
            }

            return { action, potentialLossUSD, netBenefit };
        }


        // --- 5. DASHBOARD RENDERING AND LIFECYCLE ---
        let allAlerts = [];
        let totalRiskSum = 0;

        // --- Main execution function (SYNCHRONOUS) ---
        function runFullAnalysis() { 
            document.getElementById('loading-overlay').classList.remove('hidden');
            allAlerts = [];
            totalRiskSum = 0;

            const uniqueDestinations = [...new Set(TMS_DATA.map(d => d.destination))];
            
            const externalFactorsCache = new Map(); 

            // 1. Fetch Real-Time Factors for each unique destination (Synchronous simulation)
            for (const destination of uniqueDestinations) {
                const factors = runExternalAnalysis(destination); 
                externalFactorsCache.set(destination, factors);
            }

            // 2. Process all shipments using the fetched factors
            TMS_DATA.forEach(shipment => {
                const factors = externalFactorsCache.get(shipment.destination);
                const { probability, drivers } = runAIPrediction(shipment, factors);
                const { action, potentialLossUSD, netBenefit } = prescribeAction(probability, shipment.product);
                
                totalRiskSum += probability;

                allAlerts.push({
                    ...shipment,
                    risk: probability,
                    loss: potentialLossUSD,
                    action: action,
                    benefit: netBenefit,
                    drivers: drivers,
                    factors: factors,
                });
            });

            document.getElementById('loading-overlay').classList.add('hidden');

            // 3. Initial Render
            filterAndRender();
        }

        // --- RBAC and Filtering Logic ---
        function applyRBAC(role) {
            const elements = document.querySelectorAll('[data-role="Supervisor"]');
            elements.forEach(el => {
                el.classList.toggle('hidden-rbac', role !== 'Supervisor');
            });
            renderAlertTable(allAlerts, role); 
        }

        function filterAndRender() {
            const selectedRegion = document.getElementById('region-select').value;
            const selectedRole = document.getElementById('role-select').value;

            // 1. Apply Region Filter
            const filteredAlerts = allAlerts.filter(alert => 
                selectedRegion === 'ALL' || alert.region === selectedRegion
            );

            // 2. Calculate Summary KPIs
            let totalLoss = 0;
            let totalBenefit = 0;

            const priorityQueue = filteredAlerts
                .filter(alert => {
                    const isActionable = alert.action !== 'MONITOR' && alert.action !== 'ALERT (Intervention Too Costly)';
                    totalLoss += alert.loss;
                    if (isActionable) totalBenefit += alert.benefit;
                    return isActionable;
                })
                .sort((a, b) => b.benefit - a.benefit);

            // 3. Update KPIs
            document.getElementById('kpi-total-loss').textContent = `$${totalLoss.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
            document.getElementById('kpi-total-benefit').textContent = `$${totalBenefit.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
            document.getElementById('kpi-alert-count').textContent = priorityQueue.length;
            
            // 4. Trend Analysis
            const currentAvgRisk = totalRiskSum / allAlerts.length || 0;
            renderTrendAnalysis(currentAvgRisk);

            // 5. Render Table and Charts
            renderAlertTable(priorityQueue, selectedRole);
            renderDriversChart(priorityQueue);
        }
        
        function renderTrendAnalysis(currentAvgRisk) {
            const trendIcon = document.getElementById('trend-icon');
            const trendValue = document.getElementById('trend-value');
            
            const diff = currentAvgRisk - HISTORICAL_AVG_RISK;
            const diffPercent = (Math.abs(diff) / HISTORICAL_AVG_RISK) * 100;
            
            let color = 'text-gray-600';
            let iconPath = '';
            let trendText = 'Stable';

            if (diff > 0.05) { 
                color = 'text-red-600';
                trendText = `+${diffPercent.toFixed(1)}% (High)`;
                iconPath = `<path fill-rule="evenodd" d="M14.707 10.707a1 1 0 01-1.414 0L10 7.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd"/>`;
            } else if (diff < -0.05) { 
                color = 'text-green-600';
                trendText = `-${diffPercent.toFixed(1)}% (Low)`;
                iconPath = `<path fill-rule="evenodd" d="M5.293 9.293a1 1 0 011.414 0L10 12.586l3.293-3.293a1 1 011.414 1.414l-4 4a1 1 01-1.414 0l-4-4a1 1 010-1.414z" clip-rule="evenodd"/>`;
            } else {
                trendText = 'Stable';
                iconPath = `<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM5 9a1 1 0 011-1h8a1 1 0 010 2H6a1 1 0 01-1-1z" clip-rule="evenodd"/>`;
            }
            
            trendIcon.classList.value = `w-8 h-8 ${color}`;
            trendIcon.innerHTML = iconPath;
            trendValue.textContent = trendText;
            trendValue.className = `kpi-value text-xl ${color}`;
        }
        
        function renderAlertTable(alerts, role) {
            const tbody = document.getElementById('alerts-table-body');
            tbody.innerHTML = '';
            const isSupervisor = role === 'Supervisor';
            
            if (alerts.length === 0) {
                const row = tbody.insertRow();
                const visibleCols = isSupervisor ? 9 : 5; // Total columns visible to the current role
                row.innerHTML = `<td colspan="${visibleCols}" class="px-4 py-4 text-sm text-gray-500 text-center">No high-priority, cost-justified interventions required for this region.</td>`;
                return;
            }

            alerts.forEach(alert => {
                const row = tbody.insertRow();
                const actionClass = alert.action.includes('EXPEDITE') ? 'alert-row-expedite' : (alert.action.includes('REROUTE') ? 'alert-row-reroute' : 'alert-row-monitor');
                row.className = `${actionClass} hover:shadow-lg`;

                // Common Columns 
                row.insertCell().textContent = alert.id;
                row.insertCell().textContent = alert.destination.split(',')[0].trim();
                
                const riskCell = row.insertCell();
                riskCell.textContent = `${(alert.risk * 100).toFixed(1)}%`;
                riskCell.className = 'font-bold text-red-700';

                const actionCell = row.insertCell();
                actionCell.textContent = alert.action.split('(')[0].trim();
                actionCell.className = 'font-bold';

                const driversCell = row.insertCell();
                driversCell.textContent = alert.drivers.split(',')[0].trim();
                
                // Supervisor-Only Columns 
                if (isSupervisor) {
                    row.insertCell().textContent = `$${alert.loss.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
                    
                    const benefitCell = row.insertCell();
                    benefitCell.textContent = `$${alert.benefit.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
                    benefitCell.className = 'font-bold text-green-700';

                    row.insertCell().textContent = `W:${alert.factors.weather}, S:${alert.factors.strike}, T:${alert.factors.traffic}, C:${alert.factors.customs}`;
                    row.insertCell().textContent = alert.region;
                }
            });
        }
        
        // --- RENDER CHART (Inline SVG Bar Chart for Bottom Chart) ---
        function renderDriversChart(alerts) {
            const container = document.getElementById('bottom-chart-container');
            if (alerts.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-center text-sm pt-12">No alerts to analyze.</p>`;
                return;
            }

            const driverCounts = alerts.reduce((acc, alert) => {
                const primaryDriver = alert.drivers.split(',')[0].trim();
                acc[primaryDriver] = (acc[primaryDriver] || 0) + 1;
                return acc;
            }, {});

            const sortedDrivers = Object.entries(driverCounts)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 3);
            
            const width = 1000;
            const height = 150;
            const padding = 50;
            const maxCount = sortedDrivers[0] ? sortedDrivers[0][1] : 1;
            const barHeight = 25;
            let chartSVG = `<svg width="100%" height="100%" viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet">`;

            sortedDrivers.forEach(([driver, count], index) => {
                const barLength = (count / maxCount) * (width - padding * 2);
                const yPos = index * (barHeight + 10) + 10;
                
                // Bar
                chartSVG += `<rect x="${padding}" y="${yPos}" width="${barLength}" height="${barHeight}" fill="#3b82f6" rx="3"/>`;
                
                // Label (Driver name)
                chartSVG += `<text x="5" y="${yPos + barHeight / 2 + 3}" font-size="12" fill="#4b5563">${driver}</text>`;

                // Value Label
                chartSVG += `<text x="${padding + barLength + 5}" y="${yPos + barHeight / 2 + 3}" font-size="12" fill="#1e40af" font-weight="bold">${count} Alerts</text>`;
            });

            chartSVG += `</svg>`;
            container.innerHTML = chartSVG;
        }

        // --- LIFECYCLE HOOKS ---
        document.addEventListener('DOMContentLoaded', runFullAnalysis);
        document.getElementById('role-select').addEventListener('change', filterAndRender);
        document.getElementById('region-select').addEventListener('change', filterAndRender);

    </script>
</body>
</html>